{% extends "base.html" %}

{% block title %}{{ guild.name }} - Settings{% endblock %}

{% block content %}
<div class="settings-container">
    <div class="container">
        <div class="settings-header">
            <div class="guild-header">
                {% if guild.icon %}
                    <img src="{{ guild.icon }}" alt="{{ guild.name }}" class="guild-icon-large">
                {% else %}
                    <div class="guild-icon-large-placeholder">{{ guild.name[0] }}</div>
                {% endif %}
                <div>
                    <h1>{{ guild.name }}</h1>
                    <p>Manage your server settings</p>
                </div>
            </div>
            <a href="/dashboard" class="btn btn-secondary">Back to Dashboard</a>
        </div>

        <div class="settings-layout">
            <aside class="settings-sidebar">
                <nav class="settings-nav">
                    <a href="#general" class="settings-nav-item active" data-section="general">
                        <span class="nav-icon">‚öôÔ∏è</span>
                        General
                    </a>
                    <a href="#welcome" class="settings-nav-item" data-section="welcome">
                        <span class="nav-icon">üëã</span>
                        Welcome/Goodbye
                    </a>
                    <a href="#levels" class="settings-nav-item" data-section="levels">
                        <span class="nav-icon">‚≠ê</span>
                        Leveling
                    </a>
                    <a href="#moderation" class="settings-nav-item" data-section="moderation">
                        <span class="nav-icon">üõ°Ô∏è</span>
                        Moderation
                    </a>
                    <a href="#logging" class="settings-nav-item" data-section="logging">
                        <span class="nav-icon">üìù</span>
                        Logging
                    </a>
                    <a href="#tickets" class="settings-nav-item" data-section="tickets">
                        <span class="nav-icon">üéüÔ∏è</span>
                        Tickets
                    </a>
                    <a href="#voice" class="settings-nav-item" data-section="voice">
                        <span class="nav-icon">üé§</span>
                        Voice Channels
                    </a>
                </nav>
            </aside>

            <main class="settings-content">
                <section class="settings-section active" id="general">
                    <h2 class="section-title">General Settings</h2>
                    <div class="settings-card">
                        <div class="form-group">
                            <label for="prefix">Command Prefix</label>
                            <input type="text" id="prefix" value="{{ settings.prefix }}" maxlength="10" class="form-control">
                            <small class="form-help">The prefix used for bot commands</small>
                        </div>
                        <div class="form-group">
                            <label for="language">Language</label>
                            <select id="language" class="form-control">
                                <option value="fr" {% if settings.language == 'fr' %}selected{% endif %}>French</option>
                                <option value="en" {% if settings.language == 'en' %}selected{% endif %}>English</option>
                            </select>
                        </div>
                        <button class="btn btn-primary" onclick="saveSettings('general')">Save Changes</button>
                    </div>
                </section>

                <section class="settings-section" id="welcome">
                    <h2 class="section-title">Welcome & Goodbye Messages</h2>
                    <div class="settings-card">
                        <h3>Welcome Messages</h3>
                        <div class="form-group">
                            <label class="toggle-label">
                                <input type="checkbox" id="welcome_enabled" {% if settings.welcome.enabled %}checked{% endif %}>
                                <span class="toggle-slider"></span>
                                Enable Welcome Messages
                            </label>
                        </div>
                        <div class="form-group">
                            <label for="welcome_channel">Welcome Channel ID</label>
                            <input type="text" id="welcome_channel" value="{{ settings.welcome.channel_id or '' }}" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="welcome_message">Welcome Message</label>
                            <textarea id="welcome_message" class="form-control" rows="4">{{ settings.welcome.message or '' }}</textarea>
                            <small class="form-help">Use {user} for mention, {username} for name, {server} for server name</small>
                        </div>
                    </div>

                    <div class="settings-card">
                        <h3>Goodbye Messages</h3>
                        <div class="form-group">
                            <label class="toggle-label">
                                <input type="checkbox" id="goodbye_enabled" {% if settings.goodbye.enabled %}checked{% endif %}>
                                <span class="toggle-slider"></span>
                                Enable Goodbye Messages
                            </label>
                        </div>
                        <div class="form-group">
                            <label for="goodbye_channel">Goodbye Channel ID</label>
                            <input type="text" id="goodbye_channel" value="{{ settings.goodbye.channel_id or '' }}" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="goodbye_message">Goodbye Message</label>
                            <textarea id="goodbye_message" class="form-control" rows="4">{{ settings.goodbye.message or '' }}</textarea>
                        </div>
                        <button class="btn btn-primary" onclick="saveSettings('welcome')">Save Changes</button>
                    </div>
                </section>

                <section class="settings-section" id="levels">
                    <h2 class="section-title">Leveling System</h2>
                    <div class="settings-card">
                        <div class="form-group">
                            <label class="toggle-label">
                                <input type="checkbox" id="level_enabled" {% if settings.levels.enabled %}checked{% endif %}>
                                <span class="toggle-slider"></span>
                                Enable Leveling System
                            </label>
                        </div>
                        <div class="form-group">
                            <label for="level_channel">Level Up Channel ID</label>
                            <input type="text" id="level_channel" value="{{ settings.levels.channel_id or '' }}" class="form-control">
                            <small class="form-help">Leave empty to send in the same channel</small>
                        </div>
                        <div class="form-group">
                            <label for="level_message">Level Up Message</label>
                            <textarea id="level_message" class="form-control" rows="3">{{ settings.levels.message or '' }}</textarea>
                            <small class="form-help">Use {user} for mention, {level} for level number</small>
                        </div>
                        <button class="btn btn-primary" onclick="saveSettings('levels')">Save Changes</button>
                    </div>
                </section>

                <section class="settings-section" id="moderation">
                    <h2 class="section-title">Moderation</h2>
                    <div class="settings-card">
                        <div class="form-group">
                            <label class="toggle-label">
                                <input type="checkbox" id="moderation_enabled" {% if settings.moderation.enabled %}checked{% endif %}>
                                <span class="toggle-slider"></span>
                                Enable Moderation System
                            </label>
                        </div>
                        <div class="form-group">
                            <label for="mute_role">Mute Role ID</label>
                            <input type="text" id="mute_role" value="{{ settings.moderation.mute_role_id or '' }}" class="form-control">
                            <small class="form-help">Role to assign when muting users</small>
                        </div>
                        <button class="btn btn-primary" onclick="saveSettings('moderation')">Save Changes</button>
                    </div>
                </section>

                <section class="settings-section" id="logging">
                    <h2 class="section-title">Logging</h2>
                    <div class="settings-card">
                        <div class="form-group">
                            <label for="log_channel">Log Channel ID</label>
                            <input type="text" id="log_channel" value="{{ settings.logging.channel_id or '' }}" class="form-control">
                        </div>
                        <button class="btn btn-primary" onclick="saveSettings('logging')">Save Changes</button>
                    </div>
                </section>

                <section class="settings-section" id="tickets">
                    <h2 class="section-title">Ticket System</h2>
                    <div class="settings-card">
                        <div class="form-group">
                            <label class="toggle-label">
                                <input type="checkbox" id="tickets_enabled" {% if settings.tickets.enabled %}checked{% endif %}>
                                <span class="toggle-slider"></span>
                                Enable Ticket System
                            </label>
                        </div>
                        <div class="form-group">
                            <label for="tickets_category">Tickets Category ID</label>
                            <input type="text" id="tickets_category" value="{{ settings.tickets.category_id or '' }}" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="tickets_log">Tickets Log Channel ID</label>
                            <input type="text" id="tickets_log" value="{{ settings.tickets.log_channel_id or '' }}" class="form-control">
                        </div>
                        <button class="btn btn-primary" onclick="saveSettings('tickets')">Save Changes</button>
                    </div>
                </section>

                <section class="settings-section" id="voice">
                    <h2 class="section-title">Voice Channels</h2>
                    <div class="settings-card">
                        <div class="form-group">
                            <label class="toggle-label">
                                <input type="checkbox" id="voice_enabled" {% if settings.voice.enabled %}checked{% endif %}>
                                <span class="toggle-slider"></span>
                                Enable Temporary Voice Channels
                            </label>
                        </div>
                        <div class="form-group">
                            <label for="voice_category">Voice Category ID</label>
                            <input type="text" id="voice_category" value="{{ settings.voice.category_id or '' }}" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="voice_template">Channel Name Template</label>
                            <input type="text" id="voice_template" value="{{ settings.voice.template or '' }}" class="form-control">
                            <small class="form-help">Use {user} for username</small>
                        </div>
                        <button class="btn btn-primary" onclick="saveSettings('voice')">Save Changes</button>
                    </div>
                </section>
            </main>
        </div>
    </div>
</div>

<div class="toast" id="toast"></div>
{% endblock %}

{% block extra_scripts %}
<script>
const guildId = "{{ guild.id }}";

document.querySelectorAll('.settings-nav-item').forEach(item => {
    item.addEventListener('click', function(e) {
        e.preventDefault();
        const section = this.dataset.section;

        document.querySelectorAll('.settings-nav-item').forEach(i => i.classList.remove('active'));
        document.querySelectorAll('.settings-section').forEach(s => s.classList.remove('active'));

        this.classList.add('active');
        document.getElementById(section).classList.add('active');
    });
});

async function saveSettings(section) {
    let data = {};

    switch(section) {
        case 'general':
            data = {
                prefix: document.getElementById('prefix').value,
                language: document.getElementById('language').value
            };
            break;
        case 'welcome':
            data = {
                welcome_enabled: document.getElementById('welcome_enabled').checked,
                welcome_channel_id: document.getElementById('welcome_channel').value ? parseInt(document.getElementById('welcome_channel').value) : null,
                welcome_message: document.getElementById('welcome_message').value || null,
                goodbye_enabled: document.getElementById('goodbye_enabled').checked,
                goodbye_channel_id: document.getElementById('goodbye_channel').value ? parseInt(document.getElementById('goodbye_channel').value) : null,
                goodbye_message: document.getElementById('goodbye_message').value || null
            };
            break;
        case 'levels':
            data = {
                level_enabled: document.getElementById('level_enabled').checked,
                level_channel_id: document.getElementById('level_channel').value ? parseInt(document.getElementById('level_channel').value) : null,
                level_message: document.getElementById('level_message').value || null
            };
            break;
        case 'moderation':
            data = {
                moderation_enabled: document.getElementById('moderation_enabled').checked,
                mute_role_id: document.getElementById('mute_role').value ? parseInt(document.getElementById('mute_role').value) : null
            };
            break;
        case 'logging':
            data = {
                log_channel_id: document.getElementById('log_channel').value ? parseInt(document.getElementById('log_channel').value) : null
            };
            break;
        case 'tickets':
            data = {
                tickets_enabled: document.getElementById('tickets_enabled').checked,
                tickets_category_id: document.getElementById('tickets_category').value ? parseInt(document.getElementById('tickets_category').value) : null,
                tickets_log_channel_id: document.getElementById('tickets_log').value ? parseInt(document.getElementById('tickets_log').value) : null
            };
            break;
        case 'voice':
            data = {
                voice_channels_enabled: document.getElementById('voice_enabled').checked,
                voice_channels_category_id: document.getElementById('voice_category').value ? parseInt(document.getElementById('voice_category').value) : null,
                voice_channels_template: document.getElementById('voice_template').value || null
            };
            break;
    }

    try {
        const response = await fetch(`/api/guilds/${guildId}`, {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        });

        const result = await response.json();

        if (response.ok) {
            showToast('Settings saved successfully!', 'success');
        } else {
            showToast(result.detail || 'Failed to save settings', 'error');
        }
    } catch (error) {
        showToast('An error occurred while saving settings', 'error');
    }
}

function showToast(message, type) {
    const toast = document.getElementById('toast');
    toast.textContent = message;
    toast.className = `toast toast-${type} show`;
    setTimeout(() => {
        toast.classList.remove('show');
    }, 3000);
}
</script>
{% endblock %}